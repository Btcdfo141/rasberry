<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/core-pages/core-pages.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<!--<link rel="import" href="../bower_components/core-icons/image-icons.html">-->

<polymer-element name="more-info-camera" attributes="stateObj">
<template>
  <style>

  #retry_btn {
    color: #4285f4;
  }
  paper-button.colored {
    color: #4285f4;
  }

  :host .camera-image {
    max-width: 100%;
  }
   @media (max-width: 720px) {
      :host .camera-image {
        max-width: calc(100%);
      }
    }

    @media (max-width: 620px) {
      :host .camera-image {
        max-width: calc(100%);
      }
    }

    @media (max-height: 780px) {
      :host .camera-container {
        height: 550px;
        max-width: calc(100%);
      }
    }

    :host .camera-page {
      max-width: calc(100%);
      max-height: calc(100%);
    }

  </style>

  <div hidden?="{{configureFTP}}">
    <paper-tabs selected="{{selected}}">
      <paper-tab>Camera</paper-tab>
      <paper-tab>Events</paper-tab>
      <paper-tab>Settings</paper-tab>
    </paper-tabs>

    <!--<core-pages selected="{{selected}}">-->
      <div id="camera_container" class="camera-container camera-page" hidden?="{{ selected != 0 }}">
        <template if="{{ connectionFailed }}">
          <div center vertical layout>
            <div>Could not connect to camera...</div>
            <paper-button ink id="retry_btn" on-click="{{retry}}">Retry</paper-button>
          <div>
        </template>

        <img  hidden?="{{connectionFailed}}" src="" onload="" id="camera_image" class="camera-image" />
        <div center horizontal layout>
          <div>
            <core-tooltip label="Toggle Motion Detection" position="top">
              <paper-icon-button on-click="{{toggleMotionDetection}}" icon="{{motionDetectionIcon}}"></paper-icon-button>
            </core-tooltip>
            <core-tooltip label="Take Picture" position="top">
              <paper-icon-button on-click="" icon="image:camera-alt"></paper-icon-button>
            </core-tooltip>
            <core-tooltip label="Record Camera" position="top">
              <paper-icon-button on-click="{{startRecording}}" icon="{{recordingIcon}}"></paper-icon-button>
            </core-tooltip>
          </div>
          <div flex>
            &nbsp;
          </div>
          <div>
            {{stateObj.attributes['brand']}} - {{stateObj.attributes['model_name']}}
          </div>
        </div>
      </div>
      <div class="camera-container camera-page" hidden?="{{ selected != 1 }}">Page 2</div>
      <div class="camera-container camera-page" hidden?="{{ selected != 2 }}">
        <p>
          Depending on the level of support for your current model of camera some settings may not be
          available here and will need to be set by accessing the camera's web interface directly.
        </p>
      </div>
    <!--</core-pages>-->

  </div>

  <div hidden?="{{!configureFTP}}">
    <h3>Configure FTP Settings</h3>
    <p>
      In order for this camera to notify Home Assistant when motion occurs the FTP details
      need to be configured in the camera settings first.  Home Assistant can configure these
      settings for you automatically, this process will overwrite any existing settings.
    </p>
    <p>Would you like Home Assistant to automatically configure your camera's FTP settings now?</p>
    <div center horizontal layout>
      <div>
        <paper-button on-click="{{closeFtpConfigDialog}}">
          <core-icon icon="close"></core-icon>
          Cancel
        </paper-button>
      </div>
      <div flex>
        &nbsp;
      </div>
      <div>
        <paper-button class="colored" on-click="{{setFtpDetails}}">
          <core-icon icon="check"></core-icon>
          OK
        </paper-button>
      </div>
    </div>
  </div>

</template>
<script>

  var authStore = window.hass.authStore;
  var serviceActions = window.hass.serviceActions;

  Polymer({
    stateObj: null,
    isStreaming: false,
    stillImage: null,
    reloadTime: null,
    dialogOpen: false,
    errorCount: 0,
    connectionFailed: false,
    motionDetectionIcon: 'visibility',
    configureFTP: false,
    selected: 0,
    recordingIcon: 'av:videocam',

    //document.querySelector("* /deep/ more-info-dialog").reposition(null, Date.now());

    stateObjChanged: function(oldVal, newVal) {
      this.motionDetectionIcon = (newVal.attributes['is_motion_detection_enabled']) ? 'visibility-off' : 'visibility';

    },

    toggleMotionDetection: function(ev) {
      if(!this.stateObj.attributes['is_ftp_configured']) {
        this.configureFTP = true;
        return;
      }

      if(this.stateObj.attributes['is_motion_detection_enabled'] === true) {
        serviceActions.callService("camera", "turn_off", {
          entity_id: this.stateObj.entityId,
          feature: 'motion_detection'
        });
      } else {
        serviceActions.callService("camera", "turn_on", {
          entity_id: this.stateObj.entityId,
          feature: 'motion_detection'
        });
      }
    },

    closeFtpConfigDialog: function(ev) {
      this.configureFTP = false;
    },

    setFtpDetails: function(ev) {
      serviceActions.callService("camera", "turn_on", {
          entity_id: this.stateObj.entityId,
          feature: 'configure_ftp'
        }).then(function() {
          this.configureFTP = false;
        }.bind(this));
    },

    dialogOpenChanged: function(oldVal, newVal) {
      if(newVal == true) {
        this.configureFTP = false;
        this.startImageStream();
        this.selected = 0;
        this.recordingIcon = 'av:videocam';
      }
      else {
        this.$.camera_image.src = this.stateObj.attributes['still_image_url'] + '?api_password=' + authStore.authToken + '&t=' + Date.now();
      }
    },

    startImageStream: function() {
      this.$.camera_image.src = this.stateObj.attributes['stream_url'] + '?api_password=' + authStore.authToken;
    },

    retry: function(event, detail, sender) {
      this.startImageStream();
    },

    startRecording: function() {
      this.recordingIcon = 'av:videocam-off';
    }

  });
</script>
</polymer-element>
