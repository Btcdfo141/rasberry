<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<polymer-element name="camera-image-event" attributes="cameraImageEvent">
<template>
	<style>
		:host .camera-event-thumb {
			width: calc(90%);
			display:inline;
		}
		:host .camera-thumb-list-item {
			min-width: calc(10%);
			max-width: calc(10%);
			display:inline;
		}

		:host .camera-event {
			width: calc(100%%);
		}

		:host .playback-controls {
			text-align:center;
			text-align:-webkit-center;
		}

		:host .selected-frame {
			border: solid #4285f4 2px;
		}
	</style>
	<div class='camera-image-event'>
		<div center horizontal layout>
			<div>
				<core-tooltip label="Back to Events" position="right">
					<paper-icon-button on-click="{{closeCameraEvent}}" icon="highlight-remove"></paper-icon-button>
				</core-tooltip>
			</div>
			<div flex>
				&nbsp;
			</div>
			<div>
				{{currentImage.time}}
			</div>
		</div>
		<!--<div horizontal layout center>-->
		<div class='camera-event'>
			<img class='camera-event-image' src="{{currentImage.url}}" />

			<div horizontal layout>
				<div>
					&nbsp;
				</div>
				<div flex class='playback-controls'>
					<core-tooltip label="Play/Pause" position="bottom">
						<paper-icon-button on-click="{{togglePlaying}}" icon="{{playIcon}}"></paper-icon-button>
					</core-tooltip>
				</div>
				<div>
					&nbsp;
				</div>
			</div>
			<div horizontal layout>
				<div>
					<core-tooltip label="Play/Pause" position="bottom">
						<paper-icon-button on-click="{{changeStripImagesBackward}}" icon="chevron-left"></paper-icon-button>
					</core-tooltip>
				</div>
				<div flex>
					<div layout horizontal wrap id='camera_strip'>
						<template repeat="{{cameraImage, cameraImageIndex in displayedImages}}">
					      <div flex class='camera-thumb-list-item'>
					      	<img class='camera-event-thumb {{cameraImage.classname}}' data-strip-index='{{cameraImageIndex}}' src="{{cameraImage.url}}" on-click='{{selectFrame}}' />
					      </div>
						</template>
					</div>
				</div>
				<div>
					<core-tooltip label="Play/Pause" position="bottom">
						<paper-icon-button on-click="{{changeStripImagesForward}}" icon="chevron-right"></paper-icon-button>
					</core-tooltip>
				</div>
			</div>
		</div>
	</div>

</template>
<script>
  var storeListenerMixIn = window.hass.storeListenerMixIn;

  Polymer({
    cameraImageEvent: null,
    currentImage: null,
    currentIndex: null,
    timer: null,
    playing: false,
    playIcon: 'av:play-circle-outline',
    stripDisplayEnd: 0,
    displayedImages: [],
    imagesInStrip: 10,



    cameraImageEventChanged: function(oldval, newval) {
    	if(newval) {
    		this.playing = false;
    		this.currentIndex = 0;
    		this.currentImage = this.cameraImageEvent.images[0];
    	}
    	else {
    		this.playing = false;
    		this.currentIndex = null;
    		this.currentImage = null;
    	}
    	this.stripDisplayEnd = 0;
    	this.changeStripImages(true);
    },

    closeCameraEvent: function(e) {
    	this.cameraImageEvent = null;
    },

    togglePlaying: function(e) {
    	if(this.playing) {
    		clearInterval(this.timer);
    		this.playing = false;
    	}
    	else {
    		this.timer = setInterval(function() {
    			this.showNextFrame();
    		}.bind(this), 300);
    	}
    },

    showNextFrame: function() {
    	console.log(this.currentIndex);
    	if(!this.cameraImageEvent) {
    		clearInterval(this.timer);
    		this.playing = false;
    		return;
    	}
    	this.playing = true;
    	this.currentIndex++;
    	if(this.currentIndex >= this.cameraImageEvent.images.length) {
    		this.currentIndex = 0;
    	}
    	this.currentImage = this.cameraImageEvent.images[this.currentIndex];
    	if(this.currentIndex >= this.stripDisplayEnd) {
    		this.changeStripImages(true);
    	}
    },

    playingChanged: function(oldval, newval) {
    	if(newval === true) {
    		this.playIcon = 'av:pause-circle-outline';
    	}
    	else {
    		this.playIcon = 'av:play-circle-outline';
    	}
    },

    changeStripImages: function(forward) {
    	var imagesBuffer = [];
    	if(!this.cameraImageEvent) {
    		return;
    	}

    	if(forward) {
    		if(this.stripDisplayEnd >= this.cameraImageEvent.images.length) {
    			this.stripDisplayEnd = 0;
    		}
    		var count = 0;
    		for(var i = 0; i < this.imagesInStrip; i++) {
	    		if(this.stripDisplayEnd >= this.cameraImageEvent.images.length) {
	    			//this.stripDisplayEnd = 0;
	    			break;
	    		}
	    		imagesBuffer[i] = this.cameraImageEvent.images[this.stripDisplayEnd];
	    		this.stripDisplayEnd++;
	    		count++;
	    	}
    	}
    	else {
    		var count = 0;
    		if(this.stripDisplayEnd < 0) {
    			this.stripDisplayEnd = this.cameraImageEvent.images.length - 1;
    		}
    		for(var i = this.imagesInStrip; i > 0; i--) {
	    		if(this.stripDisplayEnd < 0) {
	    			//this.stripDisplayEnd = this.cameraImageEvent.images.length - 1;
	    			break;
	    		}
	    		imagesBuffer[count] = this.cameraImageEvent.images[this.stripDisplayEnd];
	    		count++;
	    		this.stripDisplayEnd--;
	    	}
    	}

    	this.displayedImages = imagesBuffer;

    },

    changeStripImagesForward: function(e) {
    	this.changeStripImages(true);
    },

    changeStripImagesBackward: function(e) {
		this.changeStripImages(false);
    },

    currentIndexChanged: function(oldval, newval) {
    	if(!this.cameraImageEvent) {
    		return;
    	}
    	if(oldval !== 'undefined' && this.cameraImageEvent.images[oldval]) {
    		this.cameraImageEvent.images[oldval].classname = '';
    	}
    	if(newval !== 'undefined' && this.cameraImageEvent.images[newval]) {
    		this.cameraImageEvent.images[newval].classname = 'selected-frame';
    	}
    },

    selectFrame: function(evt, detail, target) {
    	var index = evt.target.attributes['data-strip-index'].value;
    	console.log(this.stripDisplayEnd, index, (this.imagesInStrip - index));
    	this.currentIndex = this.stripDisplayEnd - (this.imagesInStrip - index);
    	this.currentImage = this.cameraImageEvent.images[this.currentIndex];
    }

  });
</script>
</polymer>
