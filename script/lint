#!/bin/bash
# Execute lint to spot code mistakes.

cd "$(dirname "$0")/.."

export files="$(git diff $(git merge-base upstream/dev HEAD) --diff-filter=d --name-only | grep -e '\.py$')"
echo '================================================='
echo '=                FILES CHANGED                  ='
echo '================================================='
if [ -z "$files" ] ; then
  echo -e "No python file changed. Rather use: tox -e lint\n"
  exit
fi
printf "%s\n" $files
echo "================"
echo "LINT with flake8"
echo "================"
flake8 --doctests $files
echo "================"
echo "LINT with pylint"
echo "================"
pylint_files=$(echo "$files" | grep -v '^tests.*')
if [ -z "$pylint_files" ] ; then
  echo -e "Only test files changed. Skipping pylint\n"
else
  pylint $pylint_files
fi
echo "================"
echo "TYPING with mypy"
echo "================"
readarray -t files_array <<< "$files"
readarray -t TYPING_FILE_PATTERNS < mypyrc
declare -a typing_files
for i in "${files_array[@]}"
do
  for j in "${TYPING_FILE_PATTERNS[@]}"
  do
    [[ ${i%/*} == ${j%\/*} ]] && typing_files+=("$i")
  done
done
if [ -z "$typing_files" ] ; then
  echo -e "No typed files changed. Skipping mypy\n"
else
  printf '%s\n' "${typing_files[@]}"
  mypy "${typing_files[@]}"
fi
echo
